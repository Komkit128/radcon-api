<!-- Include one of jTable styles. -->
<link href="../../../lib/jtable/themes/metro/blue/jtable.min.css" rel="stylesheet" type="text/css" />

<!-- Include jTable script file. -->
<script src="../../../lib/jtable/jquery.jtable.min.js" type="text/javascript"></script>

<div id="HospitalTableContainer"></div>

<div id="ControlCmd">
  <input type="button" id="BackCmd" value=" Back "/>
</div>

<script type="text/javascript">
  $.ajaxSetup({
    beforeSend: function(xhr) {
      xhr.setRequestHeader('Authorization', localStorage.getItem('token'));
    }
  });

  $(document).ready(function () {
    //http://www.jtable.org/
    $('#HospitalTableContainer').jtable({
      title: 'Table of Hospital',
      paging: true,
      pageSize: 10,
      sorting: true,
      defaultSorting: 'id ASC',
      openChildAsAccordion: true,
      actions: {
        listAction: '/api/hospital/list',
        createAction: '/api/hospital/add',
        updateAction: '/api/hospital/update',
        deleteAction: '/api/hospital/delete'
      },
      fields: {
        id: {
          key: true,
          list: false
        },
        User: {
          title: '',
          width: '5%',
          sorting: false,
          edit: false,
          create: false,
          display: function (hospitalData) {
            //Create an image that will be used to open child table
            var $img = $('<img src="../../../images/multy-user.png" title="Edit Users of Hospital" width="30" height="auto"/>');
            $img.mouseover(function () {
              $(this).css({'cursor': 'pointer'});
            });

            //Open child table when user clicks the image
            $img.click(function () {
              $('#HospitalTableContainer').jtable('openChildTable', $img.closest('tr'), {
                title: 'Users โรงพยาบาล' + hospitalData.record.Hos_Name,
                paging: true,
                pageSize: 10,
                actions: {
                  listAction: '/api/user/list?hospitalId=' + hospitalData.record.id,
                  deleteAction: '/api/user/delete',
                  /*
                  deleteAction: function (postData) {
                    console.log("deleting from custom function...");
                    console.log(JSON.stringify(postData));
                    return $.Deferred(function ($dfd) {
                      $.ajax({
                        url: '/api/user/delete',
                        type: 'POST',
                        dataType: 'json',
                        data: postData,
                        success: function (data) {
                          $dfd.resolve(data);
                        },
                        error: function () {
                          $dfd.reject();
                        }
                      });
                    });
                  }
                  */
                },
                /*
                deleteConfirmation: function(data) {
                  console.log(data);
                },
                recordsLoaded: (event, data) => {
                  console.log(data);
                },
                */
                fields: {
                  hospitalId: {
                    type: 'hidden',
                    defaultValue: hospitalData.record.id
                  },
                  id: {
                    key: true,
                    create: false,
                    edit: false,
                    list: false
                  },
                  username: {
                    title: 'Username',
                    width: '10%',
                    edit: false,
                    visibility: 'fixed'
                  },
                  NameEN: {
                    title: 'name',
                    width: '10%',
                    visibility: 'fixed'
                  },
                  LastNameEN: {
                    title: 'LastName',
                    width: '10%',
                    visibility: 'fixed'
                  },
                  NameTH: {
                    title: 'ชื่อ',
                    width: '10%',
                    visibility: 'hidden'
                  },
                  LastNameTH: {
                    title: 'นามสกุล',
                    width: '10%',
                    visibility: 'hidden'
                  },
                  Email: {
                    title: 'Email',
                    width: '10%'
                  },
                  Phone: {
                    title: 'Tel',
                    width: '10%',
                    visibility: 'hidden'
                  },
                  LineID: {
                    title: 'Line ID',
                    width: '10%',
                    visibility: 'hidden'
                  },
                  Type: {
                    title: 'Type',
                    width: '10%',
                    //options: '/api/usertypes/option'
                  },
                  Status: {
                    title: 'Status',
                    width: '*',
                    //options: '/api/userstatuses/option'
                  }

                }
              }, function (data) { //opened handler
                data.childTable.jtable('load');
              });
            });
            return $img;
          }
        },
        Urgent: {
          title: '',
          width: '5%',
          sorting: false,
          edit: false,
          create: false,
          display: function (hospitalData) {
            var $img = $('<img src="../../../images/urgent-icon.png" title="Edit Urgent of Hospital" width="30" height="auto"/>');
            $img.mouseover(function () {
              $(this).css({'cursor': 'pointer'});
            });
            $img.click(function () {
              $('#HospitalTableContainer').jtable('openChildTable', $img.closest('tr'), {
                title: 'Urgent Type โรงพยาบาล' + hospitalData.record.Hos_Name,
                paging: true,
                pageSize: 10,
                actions: {
                  listAction: '/api/urgenttypes/list?hospitalId=' + hospitalData.record.id,
                  deleteAction: '/api/urgenttypes/delete',
                  updateAction: '/api/urgenttypes/update',

                  createAction: function (postData) {
                    console.log("creating from custom function...");
                    console.log(postData);

                    return $.Deferred(function ($dfd) {
                      $.ajax({
                        url: '/api/urgenttypes/add',
                        type: 'POST',
                        dataType: 'json',
                        data: postData,
                        success: function (data) {
                          $dfd.resolve(data);
                        },
                        error: function () {
                          $dfd.reject();
                        }
                      });
                    });
                    
                  },
                },
                recordsLoaded: (event, data) => {
                  console.log(data);
                },

                fields: {
                  hospitalId: {
                    type: 'hidden',
                    defaultValue: hospitalData.record.id
                  },
                  id: {
                    key: true,
                    create: false,
                    edit: false,
                    list: false
                  },
                  UGType_Name: {
                    title: 'Type Name',
                    width: '10%',
                    visibility: 'fixed'
                  },
                  UGType_ColorCode: {
                    title: 'Color Code',
                    width: '5%',
                  },
                  UGType_AcceptStep: {
                    title: 'Accept Time',
                    type: 'textarea',
                    width: '10%',
                  },
                  UGType_WorkingStep: {
                    title: 'Working Time',
                    type: 'textarea',
                    width: '10%',
                  },
                  UGType_WarningStep: {
                    title: 'Warning Time',
                    type: 'textarea',
                    width: '10%',
                  }
                }
              }, function (data) { //opened handler
                data.childTable.jtable('load');
              });
            });
            return $img;
          }
        },
        Hos_Name: {
          title: 'Name',
          width: '15%'
        },
        Hos_Address: {
          title: 'Address',
          width: '30%'
        },
        Hos_Tel: {
          title: 'Tel',
          width: '5%'
        },
        Hos_WebUrl: {
          title: 'Web Url',
          width: '10%'
        },
        Hos_Contact: {
          title: 'Web Url',
          width: '10%'
        },
        Hos_Remark: {
          title: 'Remark',
          type: 'textarea',
          width: '*'
        }
      }
    });

    $('#HospitalTableContainer').jtable('load');

    $("#BackCmd").click(()=>{
      let url = '/';
      window.location.replace(url);
    });

  });


</script>
